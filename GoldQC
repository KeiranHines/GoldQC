import os
from win32com.client  import Dispatch

def selected_array(db_path, input_string):
    """
    Loads database via COM and run input
    :param db_path: the path the the required database
    :param input_string: input for simulation
    :return: @see Dispatch.getSelectedOutputArray()
    """
    dbase = Dispatch('IPhreeqcCOM.Object')
    dbase.LoadDatabase(db_path)
    dbase.RunString(input_string)
    components = dbase.GetComponentList()
    selected_output = make_selected_output(components)
    print(selected_output)
    i = dbase.RunString(selected_output)
    print(i)
    return dbase.GetSelectedOutputArray()

def make_selected_output(components):
    """
           Build SELECTED_OUTPUT data block.
           """
    headings = "-headings    cb    H    O    "
    headings += '\t'.join(components)
    selected_output = """
           SELECTED_OUTPUT
               -reset false
           USER_PUNCH
           """
    selected_output += headings + "\n"
    # charge balance, H, and O
    code = '10 w = TOT("water")\n'
    code += '20 PUNCH CHARGE_BALANCE, TOTMOLE("H"), TOTMOLE("O")\n'
    # All other elements
    lino = 30
    for component in components:
        code += '%d PUNCH w*TOT(\"%s\")\n' % (lino, component)
        lino += 10
    selected_output += code
    return selected_output


if __name__ == '__main__':
    # TESTING ONLY TODO REMOVE
    INPUT_STRING = """
        TITLE Example 11.--Transport and ion exchange.
        SOLUTION 0  CaCl2
            units            mmol/kgw
            temp             25.0
            pH               7.0     charge
            pe               12.5    O2(g)   -0.68
            Ca               0.6
            Cl               1.2
        SOLUTION 1  Initial solution for column
            units            mmol/kgw
            temp             25.0
            pH               7.0     charge
            pe               12.5    O2(g)   -0.68
            Na               1.0
            K                0.2
            N(5)             1.2
            END
        EXCHANGE 1
            equilibrate 1
            X                0.0011
        END
            """
    results = selected_array("database/phreeqc.dat", INPUT_STRING) #Update to read from IPHREEQC database
    print(results)